<%- include('partials/header') %>

<div class="container">
  <section style="padding: 2rem 0;">
    <h2 style="margin-bottom: 1.5rem;">Server-Side Redirect Activity + A4T Implementation</h2>
    <p style="margin-bottom: 1.5rem; color: #666;">
      You arrived at this page via a server-side redirect activity. When you visited <code>/about</code>, the server called Adobe Target's <code>redirect</code> mbox, which returned instructions to redirect you here. The redirect decision and A4T tracking all happened on the server before your browser was redirected—no client-side flicker or delay.
    </p>

    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 2rem; margin-bottom: 2rem;">
      <div style="padding: 1.5rem; background: #f8f9fa; border-radius: 8px;">
        <h3 style="color: #667eea; margin-bottom: 0.5rem;">1. Target Redirect Mbox</h3>
        <p>On the <code>/about</code> route, the server calls <a href="https://github.com/johnsimmons-further/sst/blob/main/routes/pages.js#L6">getTargetOffers(['redirect'])</a> using the <code>@adobe/target-nodejs-sdk</code>. Target evaluates the visitor and returns a redirect offer with <code>type: 'redirect'</code> and the destination URL in <code>content</code>.</p>
      </div>
      <div style="padding: 1.5rem; background: #f8f9fa; border-radius: 8px;">
        <h3 style="color: #667eea; margin-bottom: 0.5rem;">2. ECID + SDID Generation</h3>
        <p>Before processing the redirect, the server ensures an ECID exists (via <code>dpm.demdex.net</code> if needed) and generates an SDID using <code>@adobe-mcid/visitor-js-server</code>. These IDs are critical for stitching Target and Analytics data together.</p>
      </div>
      <div style="padding: 1.5rem; background: #f8f9fa; border-radius: 8px;">
        <h3 style="color: #667eea; margin-bottom: 0.5rem;">3. A4T Hit Before Redirect</h3>
        <p>The server <a href="https://github.com/johnsimmons-further/sst/blob/main/routes/pages.js#L16">sends the A4T display hit</a> to Adobe Analytics <strong>before</strong> issuing the redirect. This ensures the activity impression is captured even if the user doesn't complete the redirect:<br>
        <code style="font-size: 0.8rem;">https://&lt;tracking-server&gt;/b/ss/&lt;rsid&gt;/0?pe=tnt&tnta=...&mid=...&pageName=sst:about</code></p>
      </div>
      <div style="padding: 1.5rem; background: #f8f9fa; border-radius: 8px;">
        <h3 style="color: #667eea; margin-bottom: 0.5rem;">4. Server-Side Redirect</h3>
        <p>After the A4T hit is sent, the server issues an HTTP 302 redirect to this landing page. Target automatically appends <code>mboxSession</code> and <code>adobe_mc_sdid</code> parameters to the redirect URL to maintain session continuity and analytics stitching.</p>
      </div>
      <div style="padding: 1.5rem; background: #f8f9fa; border-radius: 8px;">
        <h3 style="color: #667eea; margin-bottom: 0.5rem;">5. Why Server-Side?</h3>
        <p>Unlike client-side redirects that can cause flicker or be blocked by browsers, server-side redirects happen before any HTML is sent. The visitor experience is seamless—they simply arrive at the destination page with no visible redirect. It is as if they went directly to the redirected page in the first place.</p>
      </div>
      <div style="padding: 1.5rem; background: #f8f9fa; border-radius: 8px;">
        <h3 style="color: #667eea; margin-bottom: 0.5rem;">6. A4T Data Flow</h3>
        <p>The <code>tnta</code> token from Target (e.g., <code>647326:1:0|0,647326:1:0|2</code>) is sent via the Data Insertion API. This token contains the activity ID, experience ID, and offer ID—allowing Analytics to attribute this impression to the correct Target activity in A4T reports.</p>
      </div>
    </div>

    <div style="padding: 1.5rem; background: #e8f4f8; border-radius: 8px; border-left: 4px solid #667eea;">
      <h3 style="margin-bottom: 1rem;">Redirect Activity Flow</h3>
      <div style="font-family: monospace; font-size: 0.9rem; line-height: 1.8;">
        <div>1. Visitor requests <code>/about</code></div>
        <div>2. Server calls Target SDK → <code>getTargetOffers(['redirect'])</code></div>
        <div>3. Target returns redirect offer with <code>type: 'redirect'</code></div>
        <div>4. Server generates ECID/SDID if needed</div>
        <div>5. Server sends A4T hit → <code>pe=tnt&tnta=...</code></div>
        <div>6. Server responds with HTTP 302 → <code>/landingpage</code></div>
        <div>7. Browser follows redirect, visitor sees this page</div>
      </div>
    </div>

    <div style="margin-top: 2rem; display: flex; gap: 1rem; flex-wrap: wrap;">
      <a href="https://experience.adobe.com/#/@searchdiscovery/target/activities" target="_blank" class="btn" style="background: #667eea; color: white; text-decoration: none;">
        View Target Activities
      </a>
      <a href="https://www5.an.adobe.com/spa/?linkId=85477733-35b5-4b93-af18-21938c3bc252&dpc=pnw" target="_blank" class="btn" style="background: #f5a623; color: white; text-decoration: none;">
        View Adobe Analytics A4T Dashboard
      </a>
      <a href="/about" class="btn" style="background: #27ae60; color: white; text-decoration: none;">
        Test Redirect Again
      </a>
    </div>
  </section>
</div>

<% if (typeof isRedirectLanding !== 'undefined' && isRedirectLanding) { %>
<!-- A4T Redirect Landing Page Data (for Launch to consume) -->
<script>
  window.adobeTargetRedirectData = <%- JSON.stringify(redirectA4TData) %>;
</script>
<% } %>

<%- include('partials/footer') %>
