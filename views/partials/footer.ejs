  </main>

  <!-- Debug Box -->
  <div id="target-debug-box" style="position: fixed; bottom: 20px; right: 20px; max-width: 450px; background: #1e1e1e; color: #d4d4d4; border-radius: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.3); font-family: 'Monaco', 'Menlo', monospace; font-size: 11px; z-index: 9999;">
    <div style="background: #333; padding: 8px 12px; border-radius: 8px 8px 0 0; display: flex; justify-content: space-between; align-items: center;">
      <span style="color: #569cd6; font-weight: bold;">Target Debug Panel</span>
      <button onclick="this.parentElement.parentElement.style.display='none'" style="background: none; border: none; color: #d4d4d4; cursor: pointer; font-size: 14px;">&times;</button>
    </div>
    <div style="padding: 12px; max-height: 400px; overflow-y: auto;">

      <!-- mbox Cookie -->
      <div style="margin-bottom: 12px;">
        <div style="color: #569cd6; font-weight: bold; margin-bottom: 4px;">mbox Cookie</div>
        <div style="color: #9cdcfe; margin-bottom: 4px;"><%= debug.mboxCookieName %>:</div>
        <% if (debug.mboxCookie) { %>
          <div style="background: #2d2d2d; padding: 8px; border-radius: 4px; word-break: break-all; color: #ce9178;"><%= debug.mboxCookie %></div>
        <% } else { %>
          <div style="color: #6a9955; font-style: italic;">No mbox cookie set yet</div>
        <% } %>
      </div>

      <!-- A4T Analytics Data -->
      <div style="border-top: 1px solid #444; padding-top: 12px;">
        <div style="color: #569cd6; font-weight: bold; margin-bottom: 8px;">A4T Analytics Data</div>

        <% if (typeof targetAnalytics !== 'undefined' && targetAnalytics.length > 0) { %>
          <% targetAnalytics.forEach((item, index) => { %>
            <div style="background: #2d2d2d; padding: 10px; border-radius: 4px; margin-bottom: 8px;">
              <div style="color: #dcdcaa; font-weight: bold; margin-bottom: 6px;"><%= item.mboxName %></div>

              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 4px; margin-bottom: 6px;">
                <div><span style="color: #9cdcfe;">Activity ID:</span> <span style="color: #ce9178;"><%= item.activityId || 'N/A' %></span></div>
                <div><span style="color: #9cdcfe;">Experience ID:</span> <span style="color: #ce9178;"><%= item.experienceId || 'N/A' %></span></div>
              </div>

              <% if (item.activityName) { %>
                <div style="margin-bottom: 4px;"><span style="color: #9cdcfe;">Activity:</span> <span style="color: #6a9955;"><%= item.activityName %></span></div>
              <% } %>
              <% if (item.experienceName) { %>
                <div style="margin-bottom: 4px;"><span style="color: #9cdcfe;">Experience:</span> <span style="color: #6a9955;"><%= item.experienceName %></span></div>
              <% } %>
              <% if (item.offerName) { %>
                <div style="margin-bottom: 4px;"><span style="color: #9cdcfe;">Offer:</span> <span style="color: #6a9955;"><%= item.offerName %> (ID: <%= item.offerId %>)</span></div>
              <% } %>

              <% if (item.analyticsPayload) { %>
                <div style="margin-top: 6px;">
                  <div style="color: #9cdcfe; margin-bottom: 2px;">Analytics Payload (tnta):</div>
                  <div style="background: #1e1e1e; padding: 6px; border-radius: 3px; word-break: break-all; color: #b5cea8;"><%= JSON.stringify(item.analyticsPayload) %></div>
                </div>
              <% } %>
            </div>
          <% }) %>
        <% } else { %>
          <div style="color: #6a9955; font-style: italic;">No A4T data available (demo mode or no activities matched)</div>
        <% } %>
      </div>

      <!-- Redirect A4T Data (if this is a redirect landing page) -->
      <% if (typeof redirectA4TData !== 'undefined' && typeof isRedirectLanding !== 'undefined' && isRedirectLanding) { %>
      <div style="border-top: 1px solid #444; padding-top: 12px; margin-top: 12px;">
        <div style="color: #e94560; font-weight: bold; margin-bottom: 8px;">Redirect Landing A4T Data</div>
        <div style="background: #2d2d2d; padding: 10px; border-radius: 4px;">
          <div style="margin-bottom: 4px;"><span style="color: #9cdcfe;">Activity:</span> <span style="color: #ce9178;"><%= redirectA4TData.activityName || 'N/A' %></span> (ID: <%= redirectA4TData.activityId || 'N/A' %>)</div>
          <div style="margin-bottom: 4px;"><span style="color: #9cdcfe;">Experience:</span> <span style="color: #6a9955;"><%= redirectA4TData.experienceName || 'N/A' %></span> (ID: <%= redirectA4TData.experienceId || 'N/A' %>)</div>
          <% if (redirectA4TData.tnta) { %>
            <div style="margin-bottom: 4px;"><span style="color: #9cdcfe;">tnta:</span> <span style="color: #b5cea8;"><%= redirectA4TData.tnta %></span></div>
          <% } %>
          <% if (redirectA4TData.sdid) { %>
            <div style="margin-bottom: 4px;"><span style="color: #9cdcfe;">SDID param:</span> <span style="color: #b5cea8; word-break: break-all; font-size: 10px;"><%= redirectA4TData.sdid %></span></div>
          <% } %>
          <% if (redirectA4TData.mboxSession) { %>
            <div><span style="color: #9cdcfe;">mboxSession:</span> <span style="color: #b5cea8;"><%= redirectA4TData.mboxSession %></span></div>
          <% } %>
        </div>
      </div>
      <% } %>
    </div>
  </div>

  <!-- A4T Data for JavaScript access -->
  <script>
    window.adobeTargetA4T = <%- JSON.stringify(typeof targetAnalytics !== 'undefined' ? targetAnalytics : []) %>;

    // Helper function to send A4T display notification to Analytics
    window.sendA4TDisplayMetrics = function() {
      if (!window.adobeTargetA4T || window.adobeTargetA4T.length === 0) {
        console.log('[A4T] No analytics data to send');
        return;
      }

      window.adobeTargetA4T.forEach(function(item) {
        if (item.analyticsPayload) {
          console.log('[A4T] Display metric for:', item.mboxName, item.analyticsPayload);
          // Send to Adobe Analytics via your preferred method:
          // Option 1: Data Insertion API
          // Option 2: s.tnt variable with AppMeasurement
          // Option 3: Web SDK / alloy()
        }
      });
    };

    // Auto-send on page load (uncomment if desired)
    // document.addEventListener('DOMContentLoaded', window.sendA4TDisplayMetrics);
  </script>

  <footer>
    <p>&copy; <%= new Date().getFullYear() %> Adobe Target Demo. Built with Express + EJS.</p>
  </footer>
</body>
</html>
