  </main>

  <!-- Debug Box -->
  <div id="target-debug-box" style="position: fixed; bottom: 20px; right: 20px; max-width: 450px; background: #1e1e1e; color: #d4d4d4; border-radius: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.3); font-family: 'Monaco', 'Menlo', monospace; font-size: 11px; z-index: 9999;">
    <div style="background: #333; padding: 8px 12px; border-radius: 8px 8px 0 0; display: flex; justify-content: space-between; align-items: center;">
      <span style="color: #569cd6; font-weight: bold;">Target Debug Panel</span>
      <button onclick="this.parentElement.parentElement.style.display='none'" style="background: none; border: none; color: #d4d4d4; cursor: pointer; font-size: 14px;">&times;</button>
    </div>
    <div style="padding: 12px; max-height: 400px; overflow-y: auto;">

      <!-- mbox Cookie -->
      <div style="margin-bottom: 12px;">
        <div style="color: #569cd6; font-weight: bold; margin-bottom: 4px;">mbox Cookie</div>
        <div style="color: #9cdcfe; margin-bottom: 4px;"><%= targetDebug.mboxCookieName %>:</div>
        <% if (targetDebug.mboxCookie) { %>
          <div style="background: #2d2d2d; padding: 8px; border-radius: 4px; word-break: break-all; color: #ce9178;"><%= targetDebug.mboxCookie %></div>
        <% } else { %>
          <div style="color: #6a9955; font-style: italic;">No mbox cookie set yet</div>
        <% } %>
      </div>

      <!-- Web SDK Propositions -->
      <div style="border-top: 1px solid #444; padding-top: 12px;">
        <div style="color: #569cd6; font-weight: bold; margin-bottom: 8px;">Web SDK Propositions</div>

        <% if (typeof targetAnalytics !== 'undefined' && targetAnalytics.length > 0) { %>
          <% targetAnalytics.forEach((item, index) => { %>
            <div style="background: #2d2d2d; padding: 10px; border-radius: 4px; margin-bottom: 8px;">
              <div style="color: #dcdcaa; font-weight: bold; margin-bottom: 6px;">scope: "<%= item.mboxName %>"</div>

              <% if (item.propositionId) { %>
                <div style="margin-bottom: 6px;">
                  <div style="color: #9cdcfe; margin-bottom: 2px;">id:</div>
                  <div style="background: #1e1e1e; padding: 4px 6px; border-radius: 3px; word-break: break-all; color: #ce9178; font-size: 10px;"><%= item.propositionId %></div>
                </div>
              <% } %>

              <div style="margin-bottom: 6px;">
                <div style="color: #9cdcfe; margin-bottom: 2px;">scopeDetails:</div>
                <div style="background: #1e1e1e; padding: 6px; border-radius: 3px; margin-left: 8px;">
                  <% if (item.scopeDetailsId) { %>
                    <div style="margin-bottom: 4px; word-break: break-all;"><span style="color: #9cdcfe;">id:</span> <span style="color: #ce9178; font-size: 10px;"><%= item.scopeDetailsId %></span></div>
                  <% } %>
                  <div style="margin-bottom: 4px;"><span style="color: #9cdcfe;">activity.id:</span> <span style="color: #b5cea8;">"<%= item.activityId %>"</span></div>
                  <div style="margin-bottom: 4px;"><span style="color: #9cdcfe;">activity.name:</span> <span style="color: #6a9955;">"<%= item.activityName %>"</span></div>
                  <div style="margin-bottom: 4px;"><span style="color: #9cdcfe;">experience.id:</span> <span style="color: #b5cea8;">"<%= item.experienceId %>"</span></div>
                  <div style="margin-bottom: 4px;"><span style="color: #9cdcfe;">experience.name:</span> <span style="color: #6a9955;">"<%= item.experienceName %>"</span></div>
                  <% if (item.eventToken) { %>
                    <div style="margin-bottom: 4px; word-break: break-all;"><span style="color: #9cdcfe;">eventToken:</span> <span style="color: #ce9178; font-size: 10px;">"<%= item.eventToken %>"</span></div>
                  <% } %>
                  <% if (item.analyticsPayload && item.analyticsPayload.tnta) { %>
                    <div style="word-break: break-all;"><span style="color: #9cdcfe;">analyticsDisplayToken:</span> <span style="color: #b5cea8;">"<%= item.analyticsPayload.tnta %>"</span></div>
                  <% } %>
                </div>
              </div>
            </div>
          <% }) %>
        <% } else { %>
          <div style="color: #6a9955; font-style: italic;">No propositions (demo mode or no activities matched)</div>
        <% } %>
      </div>
    </div>
  </div>

  <!-- A4T Data for Web SDK (Launch) -->
  <script>
    // Raw analytics data from server-side Target
    window.adobeTargetA4T = <%- JSON.stringify(typeof targetAnalytics !== 'undefined' ? targetAnalytics : []) %>;

    // Pre-built Web SDK propositions array for Launch to use in sendEvent
    window.adobeTargetPropositions = (window.adobeTargetA4T || [])
      .filter(function(item) { return item.activityId; })
      .map(function(item) {
        console.log(item);
        return {
          // AT:base64-encoded JSON with activityId + experienceId
          id: item.propositionId,
          scope: item.mboxName,
          renderAttempted: true,
          scopeDetails: {
            // AT:base64-encoded JSON with activityId + experienceId + targetType
            id: item.scopeDetailsId,
            activity: {
              id: item.activityId,
              name: item.activityName
            },
            experience: {
              id: item.experienceId,
              name: item.experienceName
            },
            characteristics: {
                analyticsToken: item.analyticsPayload?.tnta || null 
              }
          }
        };
      });
  </script>

  <footer>
    <p>&copy; <%= new Date().getFullYear() %> Adobe Target Demo. Built with Express + EJS.</p>
  </footer>
</body>
</html>
